<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>操作画面</title>
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
<style type="text/css">
.circle {
	display: inline-block;
	text-align: center;
	width: 70%;
	border-radius: 50%;
	border: 2px solid #1d2087;
}

ul li {
	float: left;
	list-style: none;
	padding: 5px;
}
/* ラジオボタンは非表示にする */
input[type=radio] {
	display: none;
}
/* チェックされた時のスタイル */
input[type="radio"]:checked+label {
	background: #0063A4;
	color: #FFF;
}
/* マウスオーバーしたときのスタイル */
.label:hover {
	background-color: #E2EDF9;
}
/* lableのスタイル */
.label {
	color: #000;
	border: #dddddd solid 2px;
	display: block;
	height: 20%;
	line-height: 45px;
	padding-left: 20px;
	padding-right: 20px;
	cursor: pointer;
}
</style>

<script
	src="jquery-1.11.1.js"></script>
<script
	src="bootstrap.min.js"></script>
</head>
<body>
	<div class="container">
		<div class="row">
			<div class="col-sm-12 text-center">
				<div class="btn-group" data-toggle="buttons">
				</div>
			</div>
			<br>
			<div class="col-sm-12 text-center">
				<div class="circle"></div>
			</div>
		</div>
	</div>
	<script type="text/javascript">
var flag = false;
var socketFlag = false;
var carNo = null;
var speed = 0;
var handle = 0;

var url = "ws://" + location.host + "/arduino/client";
var ws = null;

function open(){
	ws = new WebSocket(url);

	ws.onopen = function(){
	    socketFlag = true;
	}
	ws.onmessage = function(receive) {
		$('.btn-group').empty();
		var json = JSON.parse(receive.data);
		for(i=0; i<json.length; i++){
			for(key in json[i]){
				var id = "car" + key;
				if(json[i][key]){
					$('.btn-group').append('<label id="'+id+'" class="btn btn-primary btn-lg">');
					$('.btn-group').children('#'+id).append('<input type="radio" autocomplete="off" value="'+key+'" name="carNo" >', key);
				}
			}
		}

		$("input[name='carNo']").change(function(){
		    carNo = $("input[name='carNo']:checked").val();

		});

	};

	ws.onclose = function(){
		alert("接続が切れました");
		socketFlag = false;
		flag = false;
		carNo = null;
		open();
	}
}

open();

if ($(window).width() > $(window).height()) {
    $(".circle").height($(window).height() * 0.7);
    $(".circle").width($(".circle").height());
} else {
    $(".circle").width($(window).width() * 0.7);
    $(".circle").height($(".circle").width());
}

$(window).resize(function() {
    if ($(window).width() > $(window).height()) {
        $(".circle").height($(window).height() * 0.7);
        $(".circle").width($(".circle").height());
    } else {
        $(".circle").width($(window).width() * 0.7);
        $(".circle").height($(".circle").width());
    }
});

$(".circle").mousedown(function(){
    if(!(carNo == null)) {
        flag = true;

		var json = {"carNo":carNo, "speed":speed, "handle":handle}
        console.log(json);
        ws.send(JSON.stringify(json));
    }
}).mouseleave(function(){
	if(!flag){
		return;
	}
        flag = false;
        speed = 0;
        handle = 0;

	var json = {"carNo":carNo, "speed":speed, "handle":handle}
        console.log(json);
        if(socketFlag) {
            ws.send(JSON.stringify(json));
        }
}).mouseup(function(){
	if(!flag){
		return;
	}
	flag = false;
        speed = 0;
        handle = 0;

	var json = {"carNo":carNo, "speed":speed, "handle":handle}
        console.log(json);
        if(socketFlag) {
        	ws.send(JSON.stringify(json));
        }
}).mousemove(function(e){
    if(!flag){
        return;
    }

    var x = (e.offsetX - $(this).width() / 2) / $(this).width() * 10;
    var y = ($(this).height() / 2 - e.offsetY) / $(this).height() * 10;

    var tempSpeed = Math.round((Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2))));
    if (y < 0) {
        tempSpeed = -1;
    }

    var tempHandle = Math.round(Math.atan2(x, Math.abs(y))/Math.PI * 10);
    if (tempHandle == -0) {
        tempHandle = 0;
    }

    if(tempSpeed != speed || tempHandle != handle){
        speed = tempSpeed;
        handle = tempHandle;

	var json = {"carNo":carNo, "speed":speed, "handle":handle}
        console.log(json);
        if(socketFlag) {
        	ws.send(JSON.stringify(json));
        }
    }
});
$(".circle").bind('touchstart',function(){
    if(!(carNo == null)) {
        flag = true;

		var json = {"carNo":carNo, "speed":speed, "handle":handle}
        console.log(json);
        ws.send(JSON.stringify(json));
    }
}).bind('touchend',function(){
	if(!flag){
		return;
	}
	flag = false;
        speed = 0;
        handle = 0;

	var json = {"carNo":carNo, "speed":speed, "handle":handle}
        console.log(json);
        if(socketFlag) {
        	ws.send(JSON.stringify(json));
        }
}).bind('touchmove',function(e){
    if(!flag){
        return;
    }

    var x = (e.originalEvent.changedTouches[0].pageX - $(this).offset().top - $(this).width() / 2) / $(this).width() * 10;
    var y = ($(this).height() / 2 - e.originalEvent.changedTouches[0].pageY + $(this).offset().left) / $(this).height() * 10;

    var tempSpeed = Math.round((Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2))));
    if (y < 0) {
        tempSpeed = -1;
    }

    var tempHandle = Math.round(Math.atan2(x, Math.abs(y))/Math.PI * 10);
    if (tempHandle == -0) {
        tempHandle = 0;
    }

    if(tempSpeed != speed || tempHandle != handle){
        speed = tempSpeed;
        handle = tempHandle;

	var json = {"carNo":carNo, "speed":speed, "handle":handle}
        console.log(json);
        if(socketFlag) {
        	ws.send(JSON.stringify(json));
        }
    }
});
</script>
</body>
</html>
